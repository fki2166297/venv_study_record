{% load static %}

<!DOCTYPE html>
<html class="bg-light" lang="ja">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>ルーム | StudyRecord</title>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
</head>

<body class="bg-light">
    <main class="container-md px-md-5 py-4">
        <div class="card card-body hstack gap-3 px-md-4 mb-3">
            <h5>{{ room.name }}</h5>
            <div id="elapsedTimeEnterEl">00:00:00</div>
            <div>{{ subject.name }}</div>
            <div id="elapsedTimeRecordEl">00:00:00</div>
            <a class="btn btn-link ms-auto" href="{% url 'room:select_subject' room.pk %}" role="button">教科を変更する</a>
            <button class="btn btn-secondary" id="restBtn" role="button">休憩</button>
            <form method="post" id="leaveRoomForm">
                {% csrf_token %}
                <input type="hidden" name="records">
                <button type="button" id="leaveRoomBtn" class="btn btn-danger">退室</button>
            </post>
        </div>

        <div class="row">
            <div class="col-sm-6 mb-3 mb-sm-0">
                <div class="card">
                    <h6 class="card-header">メンバー</h6>
                    <div class="card-body">
                        {% for member in room_member %}
                            <a class="text-decoration-none hstack gap-2" href="{% url 'study:account_detail' member.user.pk %}">
                                {% if member.user.icon %}
                                    <img src="/media/{{ member.user.icon }}" alt="{{ member.user.username }}" width="28" height="28" class="rounded-circle">
                                {% else %}
                                    <img src="{% static 'images/default_icon.png' %}" alt="{{ member.user.username }}" width="28" height="28" class="rounded-circle">
                                {% endif %}
                                <span>{{ member.user.username }}</span>
                            </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="card">
                    <h6 class="card-header">チャット</h6>
                    <div class="card-body">

                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous"></script>

    <script>
        fetch('{% url "room:get_room_member" room.pk %}')
            .then(response => {
                return response.json();
            })
            .then(data => {
                const room_member =
                console.log("%o", data);
                console.log(data.room_member)
            });

        function getCookie(name) {
            if (document.cookie && document.cookie !== '') {
                for (const cookie of document.cookie.split(';')) {
                    const [key, value] = cookie.trim().split('=');
                    if (key === name) {
                        return decodeURIComponent(value);
                    }
                }
            }
            return '';
        }

        function getRecord(subject) {
            const records = JSON.parse(localStorage.getItem('records'));
            for (let i = 0; i < records.length; i++) {
                if (parseInt(records[i].subject) === parseInt(subject)) {
                    return {index: i, value: records[i]};
                }
            }
            return null;
        }

        const loadedDate = new Date();

        if (!localStorage.getItem('room')) {
            const room = {
                'entry': loadedDate.toISOString(),
                'microseconds': '0',
            }
            localStorage.setItem('room', JSON.stringify(room));
        }

        if (!localStorage.getItem('records')) {
            const records = [
                {
                    'subject': '{{ subject.id }}',
                    'studied_at': loadedDate.toISOString(),
                    'microseconds': '0',
                },
            ]
            localStorage.setItem('records', JSON.stringify(records));
        }

        if (!getRecord({{ subject.id }})) {
            const records = JSON.parse(localStorage.getItem('records'));
            const record = {
                'subject': '{{ subject.id }}',
                'studied_at': loadedDate.toISOString(),
                'microseconds': '0',
            }
            records.push(record);
            localStorage.setItem('records', JSON.stringify(records));
        }

        const record = getRecord({{ subject.id }});
        const room = JSON.parse(localStorage.getItem('room'));
        let elapsedTimeRecord = 0;

        function updateRecord() {
            const records = JSON.parse(localStorage.getItem('records'));
            const newRecord = {
                'subject': record.value.subject,
                'studied_at': record.value.studied_at,
                'microseconds': elapsedTimeRecord,
            }
            records[record.index] = newRecord;
            localStorage.setItem('records', JSON.stringify(records));
        }

        function getTimeStr(microseconds) {
            const h = ('00' + Math.floor(microseconds / 1000 / 60 / 60)).slice(-2);
            const m = ('00' + Math.floor(microseconds / 1000 / 60 % 60)).slice(-2);
            const s = ('00' + Math.floor(microseconds / 1000 % 60     )).slice(-2);

            return h + ':' + m + ':' + s;
        }

        const elapsedTimeRecordEl = document.getElementById('elapsedTimeRecordEl');
        const elapsedTimeRecordDisplay = () => {
            const currentDate = new Date();
            elapsedTimeRecord = Math.floor((currentDate - loadedDate) + parseInt(record.value.microseconds));
            elapsedTimeRecordEl.innerHTML = getTimeStr(elapsedTimeRecord);
            updateRecord();
        }


        const elapsedTimeEnterEl = document.getElementById('elapsedTimeEnterEl');
        const elapsedTimeEnterDisplay = () => {
            let roomOld = JSON.parse(JSON.stringify(room));
            const currentDate = new Date();
            elapsedTimeEnter = Math.floor((currentDate - loadedDate) + parseInt(room.microseconds));
            elapsedTimeEnterEl.innerHTML = getTimeStr(elapsedTimeEnter);
            roomOld.microseconds = elapsedTimeEnter;
            localStorage.setItem('room', JSON.stringify(roomOld))
        }

        setInterval(elapsedTimeRecordDisplay, 100);
        setInterval(elapsedTimeEnterDisplay, 100);

        document.getElementById('leaveRoomBtn').addEventListener('click', () => {
            const leaveRoomForm = document.getElementById('leaveRoomForm');
            leaveRoomForm.records.value = localStorage.getItem('records');
            document.cookie = 'submit_records=yes';
            leaveRoomForm.submit();
        });
    </script>
</body>

</html>
